name: Upstream Drift Detection

on:
  schedule:
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  drift-detection:
    runs-on: ubuntu-latest
    name: Detect Upstream Divergence
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Actions"
          git remote add upstream https://github.com/block/goose.git || git remote set-url upstream https://github.com/block/goose.git

      - name: Fetch Branches
        run: |
          git fetch upstream main
          git fetch origin main

      - name: Calculate Drift
        id: drift
        run: |
          AHEAD=$(git rev-list --count upstream/main..HEAD || echo "0")
          BEHIND=$(git rev-list --count HEAD..upstream/main || echo "0")

          echo "ahead=$AHEAD" >> $GITHUB_OUTPUT
          echo "behind=$BEHIND" >> $GITHUB_OUTPUT

          echo "Commits ahead: $AHEAD"
          echo "Commits behind: $BEHIND"

      - name: Report Drift
        run: |
          echo "## Upstream Drift Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Repository: Exile10/Goose" >> $GITHUB_STEP_SUMMARY
          echo "Upstream: block/goose" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commits ahead:** ${{ steps.drift.outputs.ahead }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commits behind:** ${{ steps.drift.outputs.behind }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          BEHIND=${{ steps.drift.outputs.behind }}
          if [ "$BEHIND" -gt 5 ]; then
            echo "**Status:** Behind upstream by $BEHIND commits" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** Up to date" >> $GITHUB_STEP_SUMMARY
          fi

      - name: List Ahead Commits
        if: steps.drift.outputs.ahead != '0'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Your commits (ahead of upstream)" >> $GITHUB_STEP_SUMMARY
          git log --oneline upstream/main..HEAD >> $GITHUB_STEP_SUMMARY

      - name: List Behind Commits
        if: steps.drift.outputs.behind != '0'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Upstream commits (not in your fork)" >> $GITHUB_STEP_SUMMARY
          git log --oneline HEAD..upstream/main >> $GITHUB_STEP_SUMMARY

      - name: Create Issue If Behind
        if: steps.drift.outputs.behind > 5
        uses: actions/github-script@v7
        with:
          script: |
            const behind = parseInt('${{ steps.drift.outputs.behind }}');

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['upstream-sync']
            });

            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Sync with upstream: ' + behind + ' commits behind',
                body: 'Your fork is ' + behind + ' commits behind block/goose.\n\nRun:\n```\ngit fetch upstream main\ngit merge upstream/main\ngit push origin main\n```',
                labels: ['upstream-sync', 'maintenance']
              });
              console.log('Created sync issue');
            }

      - name: Close Issue If Synced
        if: steps.drift.outputs.behind <= 5
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['upstream-sync']
            });

            for (const issue of issues) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
              console.log('Closed issue ' + issue.number);
            }

      - name: Done
        run: |
          echo "Drift detection complete"
          echo "Ahead: ${{ steps.drift.outputs.ahead }}"
          echo "Behind: ${{ steps.drift.outputs.behind }}"
