name: Upstream Drift Detection

on:
  schedule:
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  drift-detection:
    runs-on: ubuntu-latest
    name: Detect Upstream Divergence
    timeout-minutes: 10

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Actions"

      - name: Add upstream remote and fetch
        run: |
          git remote add upstream https://github.com/block/goose.git || true
          git fetch upstream main --quiet 2>/dev/null || true
          git fetch origin main --quiet 2>/dev/null || true

      - name: Calculate drift metrics
        id: drift
        run: |
          AHEAD=$(git rev-list --count upstream/main..HEAD 2>/dev/null || echo "0")
          BEHIND=$(git rev-list --count HEAD..upstream/main 2>/dev/null || echo "0")

          echo "ahead=${AHEAD}" >> "$GITHUB_OUTPUT"
          echo "behind=${BEHIND}" >> "$GITHUB_OUTPUT"

          echo "## Upstream Drift Detection Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Repository: Exile10/Goose" >> "$GITHUB_STEP_SUMMARY"
          echo "Upstream: block/goose/main" >> "$GITHUB_STEP_SUMMARY"
          echo "Scan Date: $(date -u +'%Y-%m-%d %H:%M UTC')" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Drift Metrics" >> "$GITHUB_STEP_SUMMARY"
          echo "- Commits ahead: $AHEAD" >> "$GITHUB_STEP_SUMMARY"
          echo "- Commits behind: $BEHIND" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "$BEHIND" -gt 10 ]; then
            echo "Status: SIGNIFICANTLY BEHIND" >> "$GITHUB_STEP_SUMMARY"
          elif [ "$BEHIND" -gt 5 ]; then
            echo "Status: MODERATELY BEHIND" >> "$GITHUB_STEP_SUMMARY"
          elif [ "$BEHIND" -eq 0 ]; then
            echo "Status: IN SYNC" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Status: MINIMAL DRIFT" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: List commits ahead
        if: always()
        run: |
          AHEAD=$(git rev-list --count upstream/main..HEAD 2>/dev/null || echo "0")
          if [ "$AHEAD" -gt 0 ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Commits ahead of upstream" >> "$GITHUB_STEP_SUMMARY"
            git log --oneline upstream/main..HEAD --max-count=20 >> "$GITHUB_STEP_SUMMARY" 2>/dev/null || echo "Unable to list" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: List commits behind
        if: always()
        run: |
          BEHIND=$(git rev-list --count HEAD..upstream/main 2>/dev/null || echo "0")
          if [ "$BEHIND" -gt 0 ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Latest upstream commits (not in your fork)" >> "$GITHUB_STEP_SUMMARY"
            git log --oneline HEAD..upstream/main --max-count=20 >> "$GITHUB_STEP_SUMMARY" 2>/dev/null || echo "Unable to list" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Add sync instructions
        if: always()
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### How to Sync with Upstream" >> "$GITHUB_STEP_SUMMARY"
          echo "git fetch upstream main" >> "$GITHUB_STEP_SUMMARY"
          echo "git merge upstream/main" >> "$GITHUB_STEP_SUMMARY"
          echo "git push origin main" >> "$GITHUB_STEP_SUMMARY"

      - name: Create issue if behind
        if: steps.drift.outputs.behind > 5
        uses: actions/github-script@v7
        with:
          script: |
            const behind = parseInt('${{ steps.drift.outputs.behind }}');
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['upstream-sync']
            });
            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Upstream Sync Needed',
                body: 'Your fork is behind upstream. Run: git fetch upstream main && git merge upstream/main && git push origin main',
                labels: ['upstream-sync']
              });
            }

      - name: Close issue if synced
        if: steps.drift.outputs.behind <= 5
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['upstream-sync']
            });
            for (const issue of issues) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }

      - name: Summary
        if: always()
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Workflow Complete" >> "$GITHUB_STEP_SUMMARY"
          echo "Drift: ${{ steps.drift.outputs.behind }} behind, ${{ steps.drift.outputs.ahead }} ahead" >> "$GITHUB_STEP_SUMMARY"
