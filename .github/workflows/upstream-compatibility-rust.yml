name: Upstream Compatibility Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  compatibility-check:
    runs-on: ubuntu-latest
    name: Test Against Block/Goose Upstream

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install System Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y libdbus-1-dev gnome-keyring libxcb1-dev

      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/block/goose.git || true
          git fetch upstream main

      - name: Check merge compatibility
        run: |
          echo "## Upstream Compatibility Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Current Branch**: $(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "**Upstream Branch**: upstream/main" >> $GITHUB_STEP_SUMMARY

          # Try to merge without committing
          git fetch upstream main
          if git merge-base --is-ancestor upstream/main HEAD; then
            echo "**Status**: âœ… Up to date with upstream" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status**: âš ï¸ Behind upstream" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commits ahead**: $(git rev-list --count upstream/main..HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "**Commits behind**: $(git rev-list --count HEAD..upstream/main)" >> $GITHUB_STEP_SUMMARY

      - name: Build test
        run: |
          cd crates
          cargo build --all-targets 2>&1 | tee build.log
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "âœ… Build succeeded" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build failed" >> $GITHUB_STEP_SUMMARY
            cat build.log
            exit 1
          fi
        env:
          RUST_BACKTRACE: 1

      - name: Run tests
        run: |
          cd crates
          cargo test --lib -- --skip scenario_tests 2>&1 | tee test.log
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "âœ… Tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tests failed" >> $GITHUB_STEP_SUMMARY
            cat test.log
            exit 1
          fi
        env:
          RUST_BACKTRACE: 1
          RUST_MIN_STACK: 8388608

      - name: Generate compatibility summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "This PR has been tested for compatibility with upstream/main" >> $GITHUB_STEP_SUMMARY
          echo "Check the detailed logs above for any issues." >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR with compatibility status
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = context.payload.pull_request ? 'Compatibility check completed' : '';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸ”„ Upstream Compatibility Check\n\nThis PR has been tested against upstream/main from block/goose.\n\nSee workflow run for detailed results.'
            });
