name: Upstream Compatibility Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  compatibility-check:
    runs-on: ubuntu-latest
    name: Test Against Block/Goose Upstream
    timeout-minutes: 30

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Install System Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends libdbus-1-dev gnome-keyring libxcb1-dev
        timeout-minutes: 10

      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/block/goose.git || true
          git fetch upstream main --quiet

      - name: Check upstream compatibility
        id: compat
        run: |
          AHEAD=$(git rev-list --count upstream/main..HEAD 2>/dev/null || echo "0")
          BEHIND=$(git rev-list --count HEAD..upstream/main 2>/dev/null || echo "0")

          echo "ahead=${AHEAD}" >> "$GITHUB_OUTPUT"
          echo "behind=${BEHIND}" >> "$GITHUB_OUTPUT"

          echo "## Upstream Compatibility Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Repository: Exile10/Goose" >> "$GITHUB_STEP_SUMMARY"
          echo "Upstream: block/goose" >> "$GITHUB_STEP_SUMMARY"
          echo "Current Branch: $(git rev-parse --abbrev-ref HEAD)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Git Status" >> "$GITHUB_STEP_SUMMARY"
          echo "- Commits ahead: $AHEAD" >> "$GITHUB_STEP_SUMMARY"
          echo "- Commits behind: $BEHIND" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if git merge-base --is-ancestor upstream/main HEAD; then
            echo "Status: Compatible with upstream" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Status: Behind upstream" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Build with Cargo
        id: build
        run: |
          cd crates
          if cargo build --all-targets --quiet; then
            echo "Build: Success" >> "$GITHUB_STEP_SUMMARY"
            echo "build_status=success" >> "$GITHUB_OUTPUT"
          else
            echo "Build: Failed" >> "$GITHUB_STEP_SUMMARY"
            echo "build_status=failed" >> "$GITHUB_OUTPUT"
            exit 1
          fi
        env:
          RUST_BACKTRACE: full
          CARGO_TERM_COLOR: always

      - name: Run tests
        id: test
        run: |
          cd crates
          if cargo test --lib --quiet -- --skip scenario_tests; then
            echo "Tests: Passed" >> "$GITHUB_STEP_SUMMARY"
            echo "test_status=success" >> "$GITHUB_OUTPUT"
          else
            echo "Tests: Failed" >> "$GITHUB_STEP_SUMMARY"
            echo "test_status=failed" >> "$GITHUB_OUTPUT"
            exit 1
          fi
        env:
          RUST_BACKTRACE: full
          RUST_MIN_STACK: 8388608

      - name: Run clippy
        if: always()
        continue-on-error: true
        run: |
          cd crates
          cargo clippy --all-targets --all-features 2>&1 | tail -20 >> "$GITHUB_STEP_SUMMARY" || true
          echo "Clippy: Complete" >> "$GITHUB_STEP_SUMMARY"
        env:
          CARGO_TERM_COLOR: always

      - name: Summary
        if: always()
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Results" >> "$GITHUB_STEP_SUMMARY"
          echo "Build: ${{ steps.build.outputs.build_status || 'unknown' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Tests: ${{ steps.test.outputs.test_status || 'unknown' }}" >> "$GITHUB_STEP_SUMMARY"
