name: Pre-Submission Validation

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: "Target branch for submission (upstream or jarida)"
        required: true
        default: "upstream"
        type: choice
        options:
          - upstream
          - jarida

jobs:
  comprehensive-validation:
    runs-on: ubuntu-latest
    name: Comprehensive Pre-Submission Check

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run all code quality checks
        run: |
          echo "## Code Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          black --check . && echo "✅ Black formatting OK" >> $GITHUB_STEP_SUMMARY
          isort --check-only . && echo "✅ Import sorting OK" >> $GITHUB_STEP_SUMMARY
          flake8 . && echo "✅ Linting OK" >> $GITHUB_STEP_SUMMARY

      - name: Run all test suites
        run: |
          echo "## Test Execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          pytest tests/unit -v && echo "✅ Unit tests passed" >> $GITHUB_STEP_SUMMARY
          pytest tests/integration -v && echo "✅ Integration tests passed" >> $GITHUB_STEP_SUMMARY
          pytest tests/regression -v && echo "✅ Regression tests passed" >> $GITHUB_STEP_SUMMARY

      - name: Verify documentation updated
        run: |
          echo "## Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          docs_changed=$(git diff --name-only origin/main | grep -E '\.md$|docs/' || true)
          if [ -z "$docs_changed" ]; then
            echo "⚠️ No documentation files were modified. Consider updating docs." >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ Documentation files updated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify upstream compatibility
        run: |
          echo "## Upstream Compatibility" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          git remote add upstream https://github.com/block/goose.git || true
          git fetch upstream main
          pytest tests/ -v && echo "✅ Tests pass with current code" >> $GITHUB_STEP_SUMMARY

      - name: Generate final validation report
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            core.notice('✅ All pre-submission validation checks have PASSED!');
            core.notice('Your changes are ready to submit to ${{ inputs.target_branch }}');

      - name: Failure notification
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            core.setFailed('❌ Pre-submission validation failed. Please review the logs and fix issues before submitting.');
