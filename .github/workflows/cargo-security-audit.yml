name: Cargo Security Audit

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Thursday at 10 AM UTC
    - cron: "0 10 * * 4"
  workflow_dispatch:

jobs:
  security-audit:
    runs-on: ubuntu-latest
    name: Audit Dependencies for Vulnerabilities

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run cargo audit
        id: audit
        run: |
          echo "## Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          cargo audit --json > audit-report.json 2>&1 || true

          if cargo audit --deny warnings; then
            echo "✅ No known security vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Security issues detected (see details below)" >> $GITHUB_STEP_SUMMARY
            cargo audit --deny warnings || true
          fi

      - name: Check for outdated dependencies
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          cargo install cargo-outdated || true

          if command -v cargo-outdated &> /dev/null; then
            echo "Checking for outdated dependencies..." >> $GITHUB_STEP_SUMMARY
            cargo outdated --exit-code 0 | head -20 >> $GITHUB_STEP_SUMMARY
          fi

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- Review any reported vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "- Update dependencies with \`cargo update\`" >> $GITHUB_STEP_SUMMARY
          echo "- Run \`cargo audit fix\` for automatic fixes" >> $GITHUB_STEP_SUMMARY

      - name: Fail on vulnerabilities in production
        if: github.event_name == 'pull_request'
        run: |
          cargo audit
